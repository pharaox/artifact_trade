at_get_merchant_effect = {
	# Find an existing merchant character
	random_pool_character = {
		province = $LOCATION$
		limit = {
			at_can_be_merchant_trigger = { CHARACTER = $CHARACTER$ }
			var:at_merchant_type ?= flag:$TYPE$
			trigger_if = {
				limit = {
					at_is_saved_vanilla_merchant_trigger = { CHARACTER = $CHARACTER$ }
				}
				at_is_saved_vanilla_merchant_of_type_trigger = { CHARACTER = $CHARACTER$ TYPE = $TYPE$ }
			}
		}
		save_scope_as = $MERCHANT$
		save_scope_as = recurring_$MERCHANT$
	}
	if = {
		limit = {
			NOT = { exists = scope:$MERCHANT$ }
		}
		# Pick an appropriate character from the pool
		random_pool_character = {
			province = $LOCATION$
			limit = {
				at_can_be_merchant_trigger = { CHARACTER = $CHARACTER$ }
				NOT = { has_variable = at_merchant_type }
				trigger_if = {
					limit = {
						at_is_saved_vanilla_merchant_trigger = { CHARACTER = $CHARACTER$ }
					}
					at_is_saved_vanilla_merchant_of_type_trigger = { CHARACTER = $CHARACTER$ TYPE = $TYPE$ }
				}
			}
			save_scope_as = $MERCHANT$
		}
	}
	if = {
		limit = {
			NOT = { exists = scope:$MERCHANT$ }
		}
		# Create a new merchant character
		create_character = {
			template = generic_peasant_character
			location = $LOCATION$
			dynasty = none
			culture = $LOCATION$.culture
			faith = $LOCATION$.faith
			save_scope_as = $MERCHANT$
		}
	}

	# Mark the character as a merchant
	scope:$MERCHANT$ = {
		set_variable = { name = at_merchant_type value = flag:$TYPE$ }
	}
}

at_remember_merchant_character_effect = {
	if = {
		limit = {
			any_in_list = {
				variable = laamp_remembered_$TYPE$s_list
				this = $CHARACTER$
			}
		}
		remove_list_variable = {
			name = laamp_remembered_$TYPE$s_list
			target = $CHARACTER$
		}
	}
	add_to_variable_list = {
		name = laamp_remembered_$TYPE$s_list
		target = $CHARACTER$
		years = 10
	}
}

at_remember_visited_settlement_effect = {
	if = {
		limit = {
			any_in_list = {
				variable = laamp_visited_settlements_list
				this = $LOCATION$
			}
		}
		remove_list_variable = {
			name = laamp_visited_settlements_list
			target = $LOCATION$
		}
	}
	add_to_variable_list = {
		name = laamp_visited_settlements_list
		target = $LOCATION$
		years = 10
	}
}

at_get_artifacts_effect = {
	# Find existing artifacts for sale
	if = {
		limit = {
			any_character_artifact ?= {
				OR = {
					var:at_artifact_type ?= flag:$TYPE$
					has_variable = 1001_laamp_decision_$TYPE$
				}
			}
		}
		every_character_artifact = {
			limit = {
				OR = {
					var:at_artifact_type ?= flag:$TYPE$
					has_variable = 1001_laamp_decision_$TYPE$
				}
			}
			set_variable = { name = at_artifact_type value = flag:$TYPE$ }
			add_to_temporary_list = artifacts
		}
	}

	# Create new artifacts for sale
	while = {
		limit = {
			list_size = { name = artifacts value < 3 }
		}

		at_set_artifact_quality_or_wealth_effect = {
			NAME = quality
			LOCATION = $LOCATION$
			TYPE = $TYPE$
		}
		at_set_artifact_quality_or_wealth_effect = {
			NAME = wealth
			LOCATION = $LOCATION$
			TYPE = $TYPE$
		}
		at_create_artifact_effect = {
			TYPE = $TYPE$
			MERCHANT = $MERCHANT$
		}
		scope:newly_created_artifact ?= {
			set_variable = { name = at_artifact_type value = flag:$TYPE$ }
			set_variable = { name = suppress_artifact_notifications value = yes days = 2 }
			if = {
				limit = { at_artifact_quality_wealth_average_value >= 20 }
				at_add_scaled_artifact_modifiers_effect = yes
			}
			add_to_temporary_list = artifacts
		}
		clear_saved_scope = quality
		clear_saved_scope = wealth
	}
}

at_create_artifact_effect = {
	if = {
		limit = { flag:$TYPE$ = flag:weapon }
		create_artifact_weapon_effect = {
			OWNER = $MERCHANT$
			CREATOR = $MERCHANT$
			SET_WEAPON_TYPE = flag:no
		}
	}
	else_if = {
		limit = { flag:$TYPE$ = flag:armor }
		create_artifact_armor_effect = {
			OWNER = $MERCHANT$
			CREATOR = $MERCHANT$
			SET_ARMOR_TYPE = flag:no
		}
	}
	else_if = {
		limit = { flag:$TYPE$ = flag:accessory }
		random_list = {
			50 = {
				create_artifact_brooch_effect = {
					OWNER = $MERCHANT$
					SMITH = $MERCHANT$
				}
			}
			50 = {
				create_artifact_ring_effect = {
					OWNER = $MERCHANT$
					SMITH = $MERCHANT$
				}
			}
			50 = {
				create_artifact_necklace_effect = {
					OWNER = $MERCHANT$
					SMITH = $MERCHANT$
				}
			}
			25 = {
				create_artifact_crown_effect = {
					OWNER = $MERCHANT$
					SMITH = $MERCHANT$
				}
			}
			25 = {
				create_artifact_regalia_effect = {
					OWNER = $MERCHANT$
					SMITH = $MERCHANT$
				}
			}
		}
	}
}

at_set_artifact_quality_or_wealth_effect = {
	save_scope_value_as = {
		name = $NAME$
		value = {
			value = $LOCATION$.county.development_level
			if = {
				limit = {
					$LOCATION$ = { has_holding_type = city_holding }
				}
				add = { 5 10 }
			}
			if = {
				limit = { flag:$TYPE$ = flag:accessory }
				add = { 2 5 }
			}
			add = { -10 10 }
			min = 5
			max = 70
		}
	}
}

at_add_scaled_artifact_modifiers_effect = {
	if = {
		limit = {
			OR = {
				artifact_slot_type = primary_armament # prowess, combat / intrigue
				artifact_slot_type = armor # prowess, combat
			}
		}
		random_list = {
			1 = {
				add_scaled_artifact_modifier_prowess_effect = yes
			}
			1 = {
				add_scaled_artifact_modifier_combat_effect = yes
			}
			1 = {
				add_scaled_artifact_modifier_negate_prowess_penalty_effect = yes
			}
			1 = {
				add_scaled_artifact_modifier_terrain_advantage_effect = yes
			}
		}
	}
	else_if = {
		limit = {
			OR = {
				artifact_type = brooch # minor prestige, attractiveness, rulesrship
				artifact_type = ring # minor prestige, majesty, rulesrship
				artifact_type = necklace # minor prestige, attractiveness, majesty
			}
		}
		random_list = {
			1 = {
				add_scaled_artifact_modifier_minor_prestige_effect = yes
			}
			1 = {
				add_scaled_artifact_modifier_attractiveness_effect = yes
			}
			1 = {
				add_scaled_artifact_modifier_rulership_effect = yes
			}
			1 = {
				add_scaled_artifact_modifier_majesty_effect = yes
			}
		}
	}
	else_if = {
		limit = {
			OR = {
				artifact_slot_type = helmet # minor prestige, majesty, rulesrship
				artifact_slot_type = regalia # minor prestige, attractiveness, majesty
			}
		}
		random_list = {
			1 = {
				add_scaled_artifact_modifier_prestige_effect = yes
			}
			1 = {
				add_scaled_artifact_modifier_piety_effect = yes
			}
			1 = {
				add_scaled_artifact_modifier_rulership_effect = yes
			}
			1 = {
				add_scaled_artifact_modifier_majesty_effect = yes
			}
			1 = {
				add_scaled_artifact_modifier_hire_mercenary_effect = yes
			}
		}
	}
}

at_get_visiting_partner_effect = {
	if = {
		limit = {
			any_courtier = {
				at_is_appropriate_visiting_partner_trigger = { CHARACTER = $CHARACTER$ }
			}
		}
		random_courtier = {
			limit = {
				at_is_appropriate_visiting_partner_trigger = { CHARACTER = $CHARACTER$ }
			}
			weight = {
				base = 1
				modifier = {
					add = 1000
					is_close_family_of = $CHARACTER$
					at_has_illness_or_wounds_trigger = yes
					location = { has_holding_type = church_holding }
				}
				modifier = {
					add = 500
					is_spouse_of = $CHARACTER$
					at_has_illness_or_wounds_trigger = yes
					location = { has_holding_type = church_holding }
				}
				modifier = {
					add = 100
					has_relation_lover = $CHARACTER$
					location = { has_holding_type = church_holding }
				}
				modifier = {
					add = 20
					is_spouse_of = $CHARACTER$
				}
				modifier = {
					add = 15
					is_primary_heir_of = $CHARACTER$
				}
				modifier = {
					add = 10
					OR = {
						has_court_position = bodyguard_court_position
						has_court_position = quartermaster_camp_officer
						has_court_position = master_of_spoils_camp_officer
					}
				}
				modifier = {
					add = 5
					is_close_family_of = $CHARACTER$
				}
				modifier = {
					add = 2
					has_trait = ambitious
				}
				modifier = {
					add = -5
					has_trait = lazy
				}
			}
			save_scope_as = visiting_partner
		}
	}
}
